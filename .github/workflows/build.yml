name: Build

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-macos:
    name: Build macOS
    runs-on: macos-26
    steps:
      - name: Checkout code
        uses: actions/checkout@v4


      - name: Setup Certificates
        uses: apple-actions/import-codesign-certs@v5
        with:
          p12-file-base64: ${{ secrets.DEV_ID_P12_BASE64 }}
          p12-password: ${{ secrets.DEV_ID_P12_PASSWORD }}

      - name: Download CreateDMG
        run: |
          brew install create-dmg

      - name: Disable Swift macro plugin consent prompt
        run: |
          defaults write com.apple.dt.Xcode IDESkipMacroFingerprintValidation -bool YES

      - name: Cache Xcode DerivedData (macOS)
        uses: actions/cache@v4
        with:
          path: |
            build
          key: deriveddata-macos-${{ hashFiles('.github/workflows/build.yml') }}
          restore-keys: |
            deriveddata-macos

      - name: Build macOS .app
        run: |
          xcodebuild -workspace Paicord.xcworkspace \
            -scheme Paicord \
            -configuration Release \
            -destination "platform=macOS" \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO
          mkdir -p dist/dmg
          cp -R build/Build/Products/Release/Paicord.app dist/dmg/Paicord.app

      - name: Sign macOS .app
        run: |
          codesign --deep --force --options runtime --sign "${{ secrets.DEV_ID_IDENTITY_NAME }}" \
          dist/dmg/Paicord.app

      - name: Create DMG
        run: |
          mkdir -p dist/out
          create-dmg \
            --volname "Paicord" \
            --window-pos 200 120 \
            --window-size 510 350 \
            --icon-size 100 \
            --icon Paicord.app 160 155 \
            --hide-extension "Paicord.app" \
            --app-drop-link 350 155 \
            dist/Paicord.dmg dist/dmg

      - name: Notarize DMG
        run: |
          xcrun notarytool submit dist/Paicord.dmg --apple-id "${{ secrets.APPLE_ID_EMAIL }}" --password "${{ secrets.APPLE_ID_PASSWORD }}" --team-id "${{ secrets.APPLE_ID_TEAM }}" --wait
          xcrun stapler staple dist/Paicord.dmg

      - name: Upload Universal DMG
        uses: actions/upload-artifact@v4
        with:
          name: Paicord-macOS
          path: |
            dist/Paicord.dmg

  build-ios:
    name: Build iOS
    runs-on: macos-26
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Disable Swift macro plugin consent prompt
        run: |
          defaults write com.apple.dt.Xcode IDESkipMacroFingerprintValidation -bool YES

      - name: Install ldid
        run: |
          if command -v ldid >/dev/null 2>&1; then
            echo "ldid already installed at: $(command -v ldid)"
            ldid --version || true
          else
            echo "ldid not found â€” downloading and installing"
            curl -LO https://github.com/ProcursusTeam/ldid/releases/latest/download/ldid_macosx_x86_64
            sudo install -m755 ldid_macosx_x86_64 /usr/local/bin/ldid
            rm -f ldid_macosx_x86_64
            echo "ldid installed at: $(command -v ldid)"
          fi

      - name: Cache Xcode DerivedData (iOS)
        uses: actions/cache@v4
        with:
          path: |
            build
          key: deriveddata-ios-${{ hashFiles('.github/workflows/build.yml') }}
          restore-keys: |
            deriveddata-ios

      - name: Build iOS .ipa
        run: |
          xcodebuild -workspace Paicord.xcworkspace \
            -scheme Paicord \
            -configuration Release \
            -arch arm64 \
            -sdk iphoneos \
            -derivedDataPath build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY=""

      - name: Archive .ipa
        run: |
          set -e
          APP_PATH="build/Build/Products/Release-iphoneos/Paicord.app"
          STAGE_DIR="stage-ios"
          rm -rf Payload "$STAGE_DIR"
          mkdir -p "$STAGE_DIR/Payload"
          cp -R "$APP_PATH" "$STAGE_DIR/Payload/Paicord.app"
          if command -v strip; then
            strip "$STAGE_DIR/Payload/Paicord.app/Paicord" || true
          fi
          if [ -f Paicord/Paicord.entitlements ]; then
            ldid -SPaicord/Paicord.entitlements "$STAGE_DIR/Payload/Paicord.app/"
          else
            ldid -S"$STAGE_DIR/Payload/Paicord.app/"
          fi
          rm -rf "$STAGE_DIR/Payload/Paicord.app/_CodeSignature"
          cd "$STAGE_DIR"
          zip -r9 ../Paicord.ipa Payload
          cd ..
          mkdir -p output
          mv Paicord.ipa output/Paicord-iOS.ipa

      - name: Upload iOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Paicord-iOS
          path: output/Paicord-iOS.ipa

  notify:
    name: Notify Discord
    runs-on: ubuntu-latest
    needs: [build-macos, build-ios]
    env:
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      NIGHTLY_LINK_TOKEN: ${{ secrets.NIGHTLY_LINK_TOKEN }}
      REPO: ${{ github.repository }}
    steps:
      - name: Checkout (for git info)
        uses: actions/checkout@v4

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: Paicord-macOS
          path: output

      - name: Download iOS artifact
        uses: actions/download-artifact@v4
        with:
          name: Paicord-iOS
          path: output

      - name: Gather Info and notify Discord
        id: notify
        run: |
          set -euo pipefail

          # Ensure webhook is present
          if [ -z "${DISCORD_WEBHOOK_URL:-}" ]; then
            echo "ERROR: DISCORD_WEBHOOK_URL is not set. Add it to repository secrets." >&2
            exit 1
          fi

          # Show downloaded artifacts for debugging
          echo "Contents of output directory:"
          ls -al output || true
          echo "Recursive listing:"
          ls -alR output || true

          # Commit info
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_TITLE=$(git log -1 --pretty=%s)
          COMMIT_DESC=$(git log -1 --pretty=%b)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_AUTHOR_LOGIN=${{ github.actor }}

          # Artifact sizes (download-artifact)
          # Find the DMG and IPA files under the output directory and report human-readable sizes
          MACOS_FILE=$(find output -type f -iname "*.dmg" -print -quit || true)
          if [ -n "${MACOS_FILE:-}" ]; then
            echo "Found macOS file: $MACOS_FILE"
            MACOS_SIZE=$(du -h "$MACOS_FILE" | cut -f1)
          else
            # fallback: try to find any file whose name contains Paicord-macOS or the artifact zip
            MACOS_FILE_ALT=$(find output -type f -iname "Paicord-macOS*" -print -quit || true)
            if [ -n "${MACOS_FILE_ALT:-}" ]; then
              echo "Found macOS alternate file: $MACOS_FILE_ALT"
              MACOS_SIZE=$(du -h "$MACOS_FILE_ALT" | cut -f1)
            else
              MACOS_SIZE="unknown"
            fi
          fi

          IOS_FILE=$(find output -type f -iname "*.ipa" -print -quit || true)
          if [ -n "${IOS_FILE:-}" ]; then
            echo "Found iOS file: $IOS_FILE"
            IOS_SIZE=$(du -h "$IOS_FILE" | cut -f1)
          else
            IOS_FILE_ALT=$(find output -type f -iname "Paicord-iOS*" -print -quit || true)
            if [ -n "${IOS_FILE_ALT:-}" ]; then
              echo "Found iOS alternate file: $IOS_FILE_ALT"
              IOS_SIZE=$(du -h "$IOS_FILE_ALT" | cut -f1)
            else
              IOS_SIZE="unknown"
            fi
          fi

          # Nightly.link URLs
          NIGHTLY_MAC_URL="https://nightly.link/llsc12/Paicord/actions/runs/${GITHUB_RUN_ID}/Paicord-macOS.zip?h=${NIGHTLY_LINK_TOKEN}"
          NIGHTLY_IOS_URL="https://nightly.link/llsc12/Paicord/actions/runs/${GITHUB_RUN_ID}/Paicord-iOS.zip?h=${NIGHTLY_LINK_TOKEN}"

          # Get commit author avatar
          author_api="https://api.github.com/users/$COMMIT_AUTHOR_LOGIN"
          author_icon=$(curl -s "$author_api" | awk -F'"' '/"avatar_url"/ {print $4; exit}' || echo "")

          # Compose payload
          cat > payload.json <<EOF
          {
            "content": null,
            "embeds": [
              {
                "title": "Paicord Build",
                "description": "Commit ${COMMIT_HASH}\n\n${COMMIT_TITLE}\n${COMMIT_DESC}",
                "url": "https://github.com/${REPO}/commit/${COMMIT_HASH}",
                "color": 4063045,
                "fields": [
                  {
                    "name": "macOS",
                    "value": "[Download (${MACOS_SIZE})](${NIGHTLY_MAC_URL})",
                    "inline": true
                  },
                  {
                    "name": "iOS",
                    "value": "[Download (${IOS_SIZE})](${NIGHTLY_IOS_URL})",
                    "inline": true
                  }
                ],
                "author": {
                  "name": "${COMMIT_AUTHOR}",
                  "url": "https://github.com/${COMMIT_AUTHOR_LOGIN}",
                  "icon_url": "${author_icon}"
                }
              }
            ],
            "username": "Paicord Builds",
            "attachments": []
          }
          EOF

          # Send and capture response
          RESPONSE_FILE=response.json
          HTTP_STATUS=$(curl -sS -o "$RESPONSE_FILE" -w "%{http_code}" -H "Content-Type: application/json" -X POST -d @payload.json "$DISCORD_WEBHOOK_URL" || echo "000")

          echo "HTTP status: $HTTP_STATUS"
          echo "Response body:"
          cat "$RESPONSE_FILE" || true

          case "$HTTP_STATUS" in
            2*)
              echo "Discord webhook POST succeeded."
              ;;
            000)
              echo "ERROR: curl failed to execute." >&2
              exit 1
              ;;
            *)
              echo "ERROR: Discord webhook POST failed with status $HTTP_STATUS" >&2
              exit 1
              ;;
          esac
