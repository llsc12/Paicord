name: Build

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-macos:
    name: Build macOS
    runs-on: macos-26
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Disable Swift macro plugin consent prompt
        run: |
          defaults write com.apple.dt.Xcode IDESkipMacroFingerprintValidation -bool YES

      - name: Cache Xcode DerivedData (macOS)
        uses: actions/cache@v4
        with:
          path: |
            build
          key: deriveddata-macos-${{ hashFiles('.github/workflows/build.yml') }}
          restore-keys: |
            deriveddata-macos

      - name: Build macOS .app
        run: |
          xcodebuild -workspace Paicord.xcworkspace \
            -scheme "Paicord Release" \
            -configuration Release \
            -destination "platform=macOS" \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO

      - name: Archive macOS .app
        run: |
          mkdir -p output
          cp -R build/Build/Products/Release/Paicord.app output/Paicord.app
          cd output
          zip -r Paicord-macOS.zip Paicord.app
          rm -rf Paicord.app
          cd ..

      - name: Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Paicord-macOS
          path: output/Paicord-macOS.zip

  build-ios:
    name: Build iOS
    runs-on: macos-26
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Disable Swift macro plugin consent prompt
        run: |
          defaults write com.apple.dt.Xcode IDESkipMacroFingerprintValidation -bool YES

      - name: Install ldid
        run: |
          if command -v ldid >/dev/null 2>&1; then
            echo "ldid already installed at: $(command -v ldid)"
            ldid --version || true
          else
            echo "ldid not found â€” downloading and installing"
            curl -LO https://github.com/ProcursusTeam/ldid/releases/latest/download/ldid_macosx_x86_64
            sudo install -m755 ldid_macosx_x86_64 /usr/local/bin/ldid
            rm -f ldid_macosx_x86_64
            echo "ldid installed at: $(command -v ldid)"
          fi

      - name: Cache Xcode DerivedData (iOS)
        uses: actions/cache@v4
        with:
          path: |
            build
          key: deriveddata-ios-${{ hashFiles('.github/workflows/build.yml') }}
          restore-keys: |
            deriveddata-ios

      - name: Build iOS .ipa
        run: |
          xcodebuild -workspace Paicord.xcworkspace \
            -scheme Paicord \
            -configuration Release \
            -arch arm64 \
            -sdk iphoneos \
            -derivedDataPath build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY=""

      - name: Archive .ipa
        run: |
          set -e
          APP_PATH="build/Build/Products/Release-iphoneos/Paicord.app"
          STAGE_DIR="stage-ios"
          rm -rf Payload "$STAGE_DIR"
          mkdir -p "$STAGE_DIR/Payload"
          cp -R "$APP_PATH" "$STAGE_DIR/Payload/Paicord.app"
          if command -v strip; then
            strip "$STAGE_DIR/Payload/Paicord.app/Paicord" || true
          fi
          if [ -f Paicord/Paicord.entitlements ]; then
            ldid -SPaicord/Paicord.entitlements "$STAGE_DIR/Payload/Paicord.app/"
          else
            ldid -S"$STAGE_DIR/Payload/Paicord.app/"
          fi
          rm -rf "$STAGE_DIR/Payload/Paicord.app/_CodeSignature"
          cd "$STAGE_DIR"
          zip -r9 ../Paicord.ipa Payload
          cd ..
          mkdir -p output
          mv Paicord.ipa output/Paicord-iOS.ipa

      - name: Upload iOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Paicord-iOS
          path: output/Paicord-iOS.ipa

  notify:
    name: Notify Discord
    runs-on: ubuntu-latest
    needs: [build-macos, build-ios]
    env:
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      NIGHTLY_LINK_TOKEN: ${{ secrets.NIGHTLY_LINK_TOKEN }}
      REPO: ${{ github.repository }}
    steps:
      - name: Checkout (for git info)
        uses: actions/checkout@v4

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: Paicord-macOS
          path: output

      - name: Download iOS artifact
        uses: actions/download-artifact@v4
        with:
          name: Paicord-iOS
          path: output

      - name: Gather Info and notify Discord
        id: notify
        run: |
          set -e
          # Commit info
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_TITLE=$(git log -1 --pretty=%s)
          COMMIT_DESC=$(git log -1 --pretty=%b)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_AUTHOR_LOGIN=${{ github.actor }}

          # Artifact sizes (downloaded by download-artifact)
          MACOS_SIZE=$(ls -lh output | awk '/Paicord-macOS/ {print $5; exit}')
          IOS_SIZE=$(ls -lh output | awk '/Paicord-iOS/ {print $5; exit}')

          # Nightly.link URLs (same pattern as before)
          nightly_mac_url="https://nightly.link/llsc12/Paicord/actions/runs/${GITHUB_RUN_ID}/Paicord-macOS.zip?h=${NIGHTLY_LINK_TOKEN}"
          nightly_ios_url="https://nightly.link/llsc12/Paicord/actions/runs/${GITHUB_RUN_ID}/Paicord-iOS.zip?h=${NIGHTLY_LINK_TOKEN}"

          # Get commit author avatar (use GitHub API)
          author_api="https://api.github.com/users/$COMMIT_AUTHOR_LOGIN"
          author_icon=$(curl -s "$author_api" | grep '"avatar_url"' | head -1 | cut -d '"' -f4 || echo "")

          # Compose and send Discord payload (use unquoted heredoc so variables expand)
          cat > payload.json <<EOF
            {
              "content": null,
              "embeds": [
                {
                  "title": "Paicord Build",
                  "description": "Commit ${COMMIT_HASH}\n\n${COMMIT_TITLE}\n${COMMIT_DESC}",
                  "url": "https://github.com/${REPO}/commit/${COMMIT_HASH}",
                  "color": 4063045,
                  "fields": [
                    {
                      "name": "macOS",
                      "value": "[Download (${MACOS_SIZE})](${nightly_mac_url})",
                      "inline": true
                    },
                    {
                      "name": "iOS",
                      "value": "[Download (${IOS_SIZE})](${nightly_ios_url})",
                      "inline": true
                    }
                  ],
                  "author": {
                    "name": "${COMMIT_AUTHOR}",
                    "url": "https://github.com/${COMMIT_AUTHOR_LOGIN}",
                    "icon_url": "${author_icon}"
                  }
                }
              ],
              "username": "Paicord Builds",
              "attachments": []
            }
            EOF
          curl -H "Content-Type: application/json" -X POST -d @payload.json "$DISCORD_WEBHOOK_URL"
